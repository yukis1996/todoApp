<!DOCTYPE html>
<html lang="ja" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
	<meta charset="UTF-8">
	<title th:text="#{task.list}">タスク一覧</title>

</head>

<body>

	<div layout:fragment="content">
		<td th:text="${user.nickname} + さんのタスク"></td>

		<form action="/tasks/list" method="get" th:object="${taskForm}">

			<ul>
				<li th:each="error: ${#fields.detailedErrors()}" th:text="${error.message}"></li>
			</ul>
			
			<span th:text="#{taskName}">タスク名</span>:
			<input type="search" name="taskName" th:value="*{taskName}">
			<span th:text="#{day}">期日</span>:
			<input type="date" name="day" th:value="*{day}">
			<span th:text="#{prioritize}">優先度</span>:
			<select id="type" name="type">
            <option value="">--</option>
            <option th:each="prioritize : *{prioritizes}" th:value="${prioritize.value}"
                    th:selected="${prioritize.value} == *{type}"
                    th:text="${prioritize.label}"></option>
			</select>
			  
			<button type="submit" th:text="#{search}">検索</button>			
		</form>

		<h2 th:text="#{task.list}">タスク一覧</h2>

		<div class="section">
			<div class="container">
				<div class="box" th:id="*{taskId}" th:each="task : ${taskList}" th:object="${task}"
					th:style="'background-color:' + (${task.status} ? '' : 'gray')">
					<!-- statusがfalseの時灰色で表示する（完了の意味） -->
					<div class="mesia-content">
						<div class="content">
							<p>
								<strong class="is-size-4" th:text="*{taskName}"></strong>
								<small class="is-pulled-right">
									<span th:text="*{day}"></span>
								</small><br>
								<small class="is-pulled-right">
									<strong th:text="#{prioritize}"></strong>
									<span th:text="*{type.label}"></span>
								</small><br>
							</p>

							<div class="level">
								<span class="icon fa-2x">
									<a th:style="'display:' + (${task.status} ? 'none' : '')"
										th:onclick="|complete(this, '*{taskId}', false)|" class="has-text-success">
									<i class="far fa-check-circle"></i>										<!-- 完了済みタスク表示 -->
									</a>
									<a th:style="'display:' + (${task.status} ? '' : 'none' )"
										th:onclick="|complete(this, '*{taskId}', true)|" class="has-text-success">
										<i class="far fa-circle"></i>
										<!-- 未完了タスク表示 -->
									</a>
								</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			function complete(element, taskId, doLike) {

				const token = document.querySelector("meta[name='_csrf']").attributes['content'].value;
				const header = document.querySelector(
					"meta[name='_csrf_header']").attributes['content'].value;
				const bgColor = document.getElementById(taskId);
				let url = doLike ? "/tasks/complete" : "/tasks/incomplete";
				fetch(url, {
					method: 'POST',
					headers: {
						"Content-Type": 'application/x-www-form-urlencoded',
						[header]: token
					},
					body: `taskId=${taskId}`
				}).then(
					response => {
						if (doLike) {
							element.style.display = 'none';
							element.previousElementSibling.style.display = '';
							bgColor.style.backgroundColor = 'gray';
						} else {
							element.style.display = 'none';
							element.nextElementSibling.style.display = '';
							bgColor.style.backgroundColor = '';
						}
					}
				);
			}
		</script>
	</div>
</body>

</html>